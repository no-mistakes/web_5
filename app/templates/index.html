{% extends 'base.html' %}

{% block content %}
<div class="row">
    <div class="col-lg-12">
        <h1 class="my-5">Задание к лабораторной работе</h1>

        <p class="fw-bold">
            1. Доработайте прилагаемое к заданию веб-приложение, добавив в него
            шаблон post.html, отображающий содержимое поста.
        </p>

        <p>На странице должны присутствовать следующие элементы:</p>

        <ul class="my-3">
            <li>заголовок поста,</li>
            <li>имя автора,</li>
            <li>дата публикации,</li>
            <li>изображение,</li>
            <li>текст поста,</li>
            <li>форма «Оставьте комментарий» с полем для ввода текста и кнопкой «Отправить»,</li>
            <li>комментарии и ответы на них.</li>
        </ul>

        <p>Все данные должны подставляться в шаблон из приложения.</p>

        <p>
            <a href="https://www.tutorialrepublic.com/twitter-bootstrap-tutorial/bootstrap-media-objects.php" target="_blank">Пример</a> того, как можно сделать отображение комментариев.
        </p>

        <p>Пример возможного оформления страницы:</p>

        <img class="img-fluid my-3 border" src="{{ url_for('static', filename='images/post-example-page.png') }}" alt="Post page example">

        <p class="fw-bold">
            2. Добавьте в базовый шаблон подвал (англ. footer) сайта. Укажите там ФИО и номер группы.
        </p>

        <p>
            Выложите ваше веб-приложение на хостинг. В качестве ответа на соответствующее этой лабораторной работе задание в LMS
            вам нужно указать ссылку на репозиторий с вашим решением и ссылку на ваше приложение на хостинге. В
            случае, если репозиторий закрытый, -- не забудьте предоставить преподавателю доступ.
        </p>
    </div>
</div>

<hr class="my-5">

<h2 class="mb-3">Пользователи</h2>
<div class="table-responsive">
    <table class="table-bordered table align-middle" id="users-table">
        <thead class="table-light">
            <tr>
                <th style="width:70px">#</th>
                <th>ФИО</th>
                <th>Роль</th>
                <th style="width:280px">Действия</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

{% if current_user.is_authenticated %}
<a class="btn btn-primary" href="{{ url_for('users_create') }}">Создание пользователя</a>
{% endif %}

<script>
(async function () {
  const resp = await fetch("{{ url_for('users_json') }}");
  const data = await resp.json();
  const tbody = document.querySelector("#users-table tbody");

  const isAuth  = {{ 'true' if current_user.is_authenticated else 'false' }};
  const isAdmin = {{ 'true' if (current_user.is_authenticated and current_user.role and current_user.role.name == 'Администратор') else 'false' }};
  const meId    = {{ current_user.get_id() if current_user.is_authenticated else 'null' }};

  tbody.innerHTML = "";

  for (const u of data) {
    const canEdit   = isAuth && (isAdmin || String(meId) === String(u.id));
    const canDelete = isAuth && isAdmin;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.n}</td>
      <td>${u.fio}</td>
      <td>${u.role}</td>
      <td class="d-flex gap-2">
        <a class="btn btn-sm btn-outline-secondary" href="/users/${u.id}">Просмотр</a>
        ${canEdit ? `<a class="btn btn-sm btn-outline-primary" href="/users/${u.id}/edit">Редактировать</a>` : ``}
        ${canDelete ? `<button class="btn btn-sm btn-outline-danger" data-user-id="${u.id}" data-fio="${u.fio}">Удалить</button>` : ``}
      </td>`;
    tbody.appendChild(tr);
  }

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-user-id]");
    if (!btn) return;
    const uid = btn.getAttribute("data-user-id");
    const fio = btn.getAttribute("data-fio");
    const evt = new CustomEvent("lr4:confirmDelete", { detail: { uid, fio } });
    window.dispatchEvent(evt);
  });
})();
</script>

{% endblock %}
